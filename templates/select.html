{% extends "base.html" %}
{% block content %}

<style>
  table { width:100%; border-collapse:collapse; margin-top:1em; }
  th, td { border:1px solid #ccc; padding:0.5em; text-align:left; }
  th:nth-child(1), td:nth-child(1) { width:6%; }
  th:nth-child(2), td:nth-child(2) { width:25%; }
  th:nth-child(3), td:nth-child(3) { width:20%; }
  th:nth-child(4), td:nth-child(4) { width:12%; }
  th:nth-child(5), td:nth-child(5) { width:12%; }
  th:nth-child(6), td:nth-child(6) { width:15%; }
  th:nth-child(7), td:nth-child(7) { width:8%; }
  .relay-header td { background:#efefef; font-weight:bold; padding:0.5em; }
</style>

<h2>Select Team-Seasons &amp; Event</h2>

<form method="post" action="{{ url_for('main.select') }}">
  {{ form.hidden_tag() }}

  <p>
    <input
      type="text"
      id="teamSearch"
      placeholder="Search teamsâ€¦"
      style="width:100%;padding:0.5em;margin-bottom:0.5em;">
  </p>

  <fieldset>
    <legend>{{ form.teams.label }}</legend>
    {% for sub in form.teams %}
      <label>{{ sub() }} {{ sub.label.text }}</label><br>
    {% endfor %}
  </fieldset>

  <p>
    {{ form.event.label }}<br>
    {{ form.event() }}
  </p>
  <p>
    {{ form.top_n.label }}<br>
    {{ form.top_n() }}
  </p>
  {% if form.event.data in RELAYS %}
  <p>
    {{ form.scoring_mode.label }}<br>
    {{ form.scoring_mode() }}
  </p>
  {% endif %}

  {# carry every swimmer/time and exclusion across submits #}
  {% for s in swimmers %}
    <input type="hidden" name="time_id"    value="{{ s.time_id }}">
  {% endfor %}
  {% for ex in excluded %}
    <input type="hidden" name="excluded"   value="{{ ex }}">
  {% endfor %}

  <p>
    <button type="submit" name="action" value="get">Get Top Swimmers</button>
    <button type="submit" name="export_excel" value="1">Export Excel</button>
    <button type="submit" name="action" value="recalc">Recalculate</button>
    <button type="submit" name="action" value="remove" style="color:red">
      Remove Selected Team/Season
    </button>    <a href="{{ url_for('main.select') }}" class="button">Reset All</a>
  </p>

  {% if swimmers %}
    <table>
      <thead>
        <tr>
          <th>Include?</th>
          {% if form.event.data not in RELAYS %}
            <th>Place</th><th>Name</th><th>Team (Season)</th>
            <th>Time</th><th>Points</th>
          {% else %}
            <th>Name</th><th>Team (Season)</th>
            <th>Stroke</th><th>Split</th>
            <th>Relay Time</th><th>Points</th>
          {% endif %}
        </tr>
      </thead>

      {% if form.event.data in RELAYS %}
        {% for group in swimmers|groupby('combo_rank') %}
        <tbody>
          <tr class="relay-header">
            <td colspan="7">Relay {{ group.grouper }}</td>
          </tr>
          {% for s in group.list %}
          <tr>
            <td>
              <input
                type="checkbox"
                name="include_time_id"
                value="{{ s.time_id }}"
                {% if s.time_id not in excluded %}checked{% endif %}>
            </td>
            <td>{{ s.name }}</td>
            <td>{{ s.team }} ({{ s.season }})</td>
            <td>{{ s.stroke }}</td>
            <td>{{ s.time_fmt }}</td>
            <td>{{ s.combo_time_fmt }}</td>
            <td>{{ s.points or '' }}</td>
          </tr>
          {% endfor %}
        </tbody>
        {% endfor %}
      {% else %}
        <tbody>
          {% for s in swimmers %}
          <tr>
            <td>
              <input
                type="checkbox"
                name="include_{{ loop.index0 }}"
                {% if s.time_id not in excluded %}checked{% endif %}>
            </td>
            <td>{{ s.combo_rank }}</td>
            <td>{{ s.name }}</td>
            <td>{{ s.team }} ({{ s.season }})</td>
            <td>{{ s.time_fmt }}</td>
            <td>{{ s.points }}</td>
          </tr>
          {% endfor %}
        </tbody>
      {% endif %}
    </table>
  {% endif %}

</form>

<script>
  document.getElementById('teamSearch').addEventListener('input', function(e) {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('fieldset label').forEach(label => {
      label.style.display = label.textContent.toLowerCase().includes(q)
        ? '' : 'none';
    });
  });
</script>

{% endblock %}
